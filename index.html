<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal-OS v2.0</title>
    <!-- Web App Manifest for Mobile Installation -->
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        charcoal: '#121212',
                        'neon-indigo': '#4f46e5',
                        'soft-amber': '#f59e0b',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Specific drag n drop styles not handled by tailwind */
        .task-item.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.1);
        }

        .kanban-dropzone.drag-over {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }

        /* Smooth Accordion Styles */
        .trip-accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
            opacity: 0;
        }

        .trip-accordion.expanded .trip-accordion-content {
            max-height: 500px;
            /* arbitrary large enough number for content */
            opacity: 1;
        }

        .trip-chevron {
            transition: transform 0.3s ease;
        }

        .trip-accordion.expanded .trip-chevron {
            transform: rotate(180deg);
        }

        /* Mobile specific overrides */
        @media (max-width: 1024px) {
            .mobile-fullscreen-scroll {
                /* Override the fixed 80vh to allow full content scrolling on mobile */
                height: auto !important;
                min-height: 100vh;
            }
        }
    </style>
    <!-- Mobile Drag and Drop Polyfill for iOS Safari Parity -->
    <script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>
</head>

<body class="min-h-screen relative flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
    <div class="ambient-glow-subtle hide-in-zen"></div>

    <!-- Top Navigation & Zen Toggle -->
    <div
        class="w-full max-w-[1400px] flex flex-col md:flex-row justify-between items-center mb-8 gap-6 md:gap-0 transition-all duration-700 relative z-50">
        <h1
            class="text-2xl font-bold tracking-tight text-white/90 hide-in-zen transition-opacity duration-500 text-center md:text-left">
            Sabrina's <span style="color: var(--accent-text)" class="transition-colors duration-800">Control
                Centre</span></h1>

        <!-- Center Context Widget (HUD) -->
        <div id="header-hud"
            class="hidden md:flex flex-col items-center justify-center text-white/60 hide-in-zen transition-opacity duration-500 cursor-default">
            <div class="flex items-center space-x-3 text-sm font-medium tracking-wide">
                <span id="hud-date" class="uppercase text-white/50 text-xs">Loading Date...</span>
                <span class="w-1 h-1 rounded-full bg-white/20"></span>
                <span id="hud-time" class="text-white/80 font-bold text-lg">--:--</span>
                <span class="w-1 h-1 rounded-full bg-white/20"></span>
                <span id="hud-weather" class="flex items-center">
                    <svg class="w-4 h-4 animate-pulse mr-1" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </span>
            </div>
            <div class="flex items-center space-x-2 mt-0.5">
                <div id="hud-location" class="text-[10px] text-white/30 tracking-widest uppercase">London, UK</div>
                <span class="text-[10px] text-white/20">‚Ä¢</span>
                <span id="hud-last-sync" class="text-[10px] text-white/30 tracking-widest uppercase">SYNCED:
                    --:--</span>
            </div>
        </div>

        <div class="flex flex-wrap justify-center items-center gap-4">
            <!-- Context Toggle -->
            <div class="glass flex items-center rounded-full p-1 hide-in-zen transition-opacity duration-500">
                <button id="context-professional"
                    class="px-4 py-1.5 rounded-full text-xs font-semibold tracking-wide transition-all bg-white/10 text-white/90">Professional</button>
                <button id="context-personal"
                    class="px-4 py-1.5 rounded-full text-xs font-semibold tracking-wide transition-all text-white/40 hover:text-white/70">Personal</button>
            </div>

            <!-- Auth Status -->
            <button id="auth-status"
                class="text-sm font-medium px-4 py-2 rounded-full glass border-red-500/30 text-red-400 hide-in-zen transition-opacity duration-500 cursor-pointer hover:bg-red-500/10 active:scale-95">
                Google Not Connected
            </button>

            <!-- Zen Mode Toggle -->
            <button id="zen-toggle"
                class="glass px-6 py-2 rounded-full font-medium text-sm hover:bg-white/10 transition-colors flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                    </path>
                </svg>
                <span>Enter Zen Mode</span>
            </button>
        </div>
    </div>

    <!-- Main Sunsama 3-Column Layout -->
    <div id="main-layout"
        class="w-full max-w-[1400px] grid grid-cols-1 lg:grid-cols-12 gap-6 h-auto lg:h-[80vh] transition-all duration-700 opacity-100 scale-100">

        <!-- Column 1: Actionable Inbox -->
        <div class="lg:col-span-3 flex flex-col space-y-6 h-auto lg:h-full hide-in-zen transition-all-slow">
            <div class="rounded-2xl p-5 glass-card flex-grow overflow-hidden flex flex-col">
                <div class="mb-4">
                    <h2 class="text-md font-semibold flex items-center text-white/90 mb-1">
                        <svg class="w-5 h-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                        Actionable Inbox
                    </h2>
                    <p class="text-xs text-white/50 ml-7 leading-tight">Drag unread emails to create follow-up tasks</p>
                </div>
                <div id="inbox-container" class="flex-grow overflow-y-auto pr-2 space-y-3">
                    <div class="text-sm text-white/40 italic">Loading messages...</div>
                </div>
            </div>

            <!-- Bottom of Column 1: Dynamic Panel (Quick Notes / MailCraft) -->
            <div id="dynamic-notes-container" class="relative min-h-[420px] shrink-0 flex flex-col mt-4">

                <!-- Quick Notes Scratchpad -->
                <div id="quick-notes-panel"
                    class="absolute inset-0 rounded-2xl p-5 glass-card flex flex-col transition-opacity duration-300 opacity-100 z-10 pointer-events-auto">
                    <h2 class="text-md font-semibold flex items-center text-white/90 mb-3 shrink-0">
                        <svg class="w-4 h-4 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                            </path>
                        </svg>
                        Quick Notes
                    </h2>
                    <textarea id="quick-notes-area"
                        class="w-full flex-grow bg-transparent text-sm text-white/80 placeholder-white/30 resize-none focus:outline-none"
                        placeholder="Jot down thoughts here... (auto-saves)"></textarea>
                    <div class="text-right mt-1">
                        <span id="notes-save-status"
                            class="text-xs text-white/40 italic transition-opacity opacity-0">Saved</span>
                    </div>
                </div>

                <!-- MailCraft Interface -->
                <div id="mailcraft-panel"
                    class="absolute inset-0 rounded-2xl glass-card flex flex-col transition-opacity duration-300 opacity-0 pointer-events-none z-0 overflow-hidden"
                    style="backdrop-filter: blur(15px);">
                    <!-- Header -->
                    <div class="bg-white/5 p-3 shrink-0 border-b border-white/10 flex justify-between items-center">
                        <div class="flex items-center">
                            <h2 class="text-sm font-semibold flex items-center text-white/90">
                                <svg class="w-4 h-4 mr-2 text-white" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                    </path>
                                </svg>
                                <span>MailCraft</span>
                            </h2>
                        </div>
                        <button id="close-mailcraft-btn"
                            class="w-6 h-6 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 transition-colors text-white/60 hover:text-white/90">
                            ‚úï
                        </button>
                    </div>

                    <!-- Body -->
                    <div class="flex flex-col flex-grow p-4 gap-3 overflow-y-auto w-full">
                        <div class="flex flex-col gap-1 shrink-0">
                            <input type="hidden" id="mailcraft-reply-context" value="">
                            <input type="hidden" id="mailcraft-reply-message-id" value="">
                            <div class="text-[10px] text-white/70 uppercase tracking-widest truncate w-full"
                                id="mailcraft-context-label">Replying to:</div>
                        </div>

                        <textarea id="mailcraft-draft-text"
                            class="w-full min-h-[80px] scrollbar-thin bg-black/40 rounded-xl p-4 text-sm text-white placeholder-white/50 resize-none focus:outline-none focus:ring-1 shadow-inner ring-1 ring-white/10 transition-shadow shrink-0"
                            style="--tw-ring-color: var(--accent-text);"
                            placeholder="Rough thoughts for your reply..."></textarea>

                        <div class="flex flex-col gap-3 shrink-0 mb-2">
                            <span
                                class="text-[11px] text-white/50 uppercase tracking-widest font-bold flex justify-between mb-1">
                                Select Tone
                                <span id="mailcraft-selected-tone-label"
                                    class="font-bold text-white uppercase">PROFESSIONAL</span>
                            </span>
                            <div id="mailcraft-tones-container" class="flex flex-wrap gap-2.5 w-full">
                                <!-- Generated Dynamically -->
                            </div>
                        </div>

                        <div class="mt-auto pt-2 shrink-0">
                            <button id="mailcraft-generate-btn"
                                class="w-full min-h-[48px] rounded-xl bg-[#333333] hover:bg-[#444444] disabled:opacity-50 disabled:cursor-not-allowed transition-all text-sm font-bold flex justify-center items-center text-white border border-white/5">
                                Generate Draft <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </button>

                            <!-- Output -->
                            <div id="mailcraft-output-container" class="hidden flex-col gap-2 mt-2">
                                <div class="flex justify-between items-center">
                                    <span
                                        class="text-[10px] text-white/50 uppercase tracking-widest font-semibold">Generated
                                        Result</span>
                                    <div class="flex items-center gap-2">
                                        <button id="mailcraft-copy-btn"
                                            class="text-[10px] uppercase font-bold tracking-wider px-2 py-1 rounded bg-white/10 hover:bg-white/20 transition-colors text-white/70 flex items-center gap-1">
                                            Copy <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3">
                                                </path>
                                            </svg>
                                        </button>
                                        <button id="mailcraft-send-btn" onclick="sendMailCraftReply()"
                                            class="text-[10px] border disabled:opacity-50 disabled:cursor-not-allowed uppercase font-bold tracking-wider px-2 py-1 rounded transition-colors flex items-center gap-1"
                                            style="background: var(--accent-text); color: black; border-color: transparent; box-shadow: 0 0 10px var(--accent-text);">
                                            Send <svg class="w-3 h-3" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <pre id="mailcraft-output-text"
                                    class="bg-black/30 rounded-xl p-3 text-sm text-white/90 whitespace-pre-wrap font-sans min-h-[100px] border border-white/5 ring-1 ring-inset ring-white/10"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Column 2: Tasks & Upcoming Trips Stacked -->
        <div class="lg:col-span-6 flex flex-col space-y-6 h-auto lg:h-[80vh] hide-in-zen transition-all-slow">

            <!-- Daily Rituals (Top of Column 2) -->
            <div class="rounded-2xl p-4 glass-card shrink-0">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-sm font-semibold flex items-center text-white/90">
                        <svg class="w-4 h-4 mr-2 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        Daily Rituals
                    </h2>
                    <button onclick="addRitual()"
                        class="text-white/40 hover:text-pink-400 transition-colors cursor-pointer p-1"
                        title="Add Ritual">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                    </button>
                </div>
                <div id="rituals-container" class="space-y-2 max-h-[140px] overflow-y-auto pr-1">
                    <div class="text-xs text-white/40 italic">Loading rituals...</div>
                </div>
            </div>

            <!-- Tasks (Top Half) -->
            <div class="rounded-2xl p-6 glass-card flex-1 flex flex-col overflow-hidden min-h-[300px]">
                <h2 class="text-lg font-semibold flex items-center text-white/90 mb-4">
                    <svg class="w-5 h-5 mr-2 text-soft-amber" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Tasks
                </h2>
                <form id="quick-add-form" class="mb-4 relative">
                    <input type="text" id="quick-add-input"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 pl-12 text-sm text-white focus:outline-none focus:border-soft-amber transition-colors"
                        placeholder="Type a task and hit Enter...">
                    <span
                        class="absolute left-4 top-3.5 text-white/40 font-mono text-xs border border-white/20 rounded px-1">A</span>
                    <button type="submit" class="absolute right-3 top-2.5 p-1 text-white/40 hover:text-white/80">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                    </button>
                </form>

                <div class="flex-grow overflow-y-auto pr-2 min-h-0 space-y-4 kanban-container">
                    <div>
                        <h3 class="text-xs uppercase tracking-wider font-semibold text-white/40 mb-2 ml-1">Focus /
                            Doing
                        </h3>
                        <div class="space-y-2 kanban-dropzone min-h-[40px] rounded-xl border border-dashed border-transparent transition-all"
                            id="list-doing" data-status="doing">
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xs uppercase tracking-wider font-semibold text-white/40 mb-2 ml-1 mt-4">Next
                            Up
                            / Todo</h3>
                        <div class="space-y-2 kanban-dropzone min-h-[40px] rounded-xl border border-dashed border-transparent transition-all"
                            id="list-todo" data-status="todo">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trips (Bottom Half) -->
            <div class="rounded-2xl p-5 glass-card flex-1 flex flex-col overflow-hidden min-h-[300px]">
                <h2 class="text-md font-semibold flex items-center text-white/90 mb-4 shrink-0">
                    <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Upcoming Trips
                </h2>
                <div id="trips-container" class="flex-grow overflow-y-auto pr-2 space-y-3">
                    <div class="text-sm text-white/40 italic">Syncing Calendar data...</div>
                </div>
            </div>
        </div>


        <!-- Column 3: Events & Pomodoro -->
        <div
            class="lg:col-span-3 flex flex-col rounded-2xl p-6 glass-card h-auto min-h-[500px] lg:h-[80vh] lg:overflow-hidden hide-in-zen transition-all-slow">

            <!-- Focus Heatmap -->
            <div class="mb-6 pb-6 border-b border-white/10 shrink-0">
                <h2 class="text-sm font-semibold flex items-center justify-between text-white/90 mb-4">
                    <span class="flex items-center">
                        <svg class="w-4 h-4 mr-2 text-soft-amber" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Focus Heatmap
                    </span>
                    <span id="pomodoro-stats" class="text-xs text-white/50 font-mono tracking-wider">0m TODAY</span>
                </h2>
                <div id="focus-heatmap-container"
                    class="flex flex-row items-end justify-between space-x-1 h-14 w-full mt-2">
                    <!-- Bars injected via JS -->
                </div>
            </div>

            <div class="mb-6 shrink-0">
                <h2 class="text-lg font-semibold flex items-center text-white/90 mb-1">
                    <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    Events
                </h2>
            </div>
            <div id="calendar-container" class="flex-grow overflow-y-auto pr-2 space-y-4">
                <div class="flex flex-col items-center justify-center h-full text-white/40">
                    <svg class="w-8 h-8 mb-2 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span>Loading Events...</span>
                </div>
            </div>
        </div>


        <!-- Invisible structure to align perfectly with Schedule bottom half -->
        <div class="flex-1 min-h-[300px] pointer-events-none"></div>
    </div>
    </div>

    <!-- Zen Focus Overlay -->
    <div id="zen-layout"
        class="fixed inset-0 z-40 hidden flex-col items-center justify-center pointer-events-none opacity-0 transition-opacity duration-700 bg-black/20 backdrop-blur-sm">

        <div
            class="pointer-events-auto text-center max-w-4xl px-8 py-16 w-full glass-card rounded-3xl mx-auto shadow-2xl flex flex-col items-center justify-center relative backdrop-blur-2xl bg-black/40 border-white/10 m-6">
            <h2 class="text-sm uppercase tracking-[0.4em] text-white/60 mb-8 flex items-center justify-center">
                <svg class="w-4 h-4 mr-3 text-soft-amber" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Focus Flow
            </h2>
            <div id="zen-task-display"
                class="text-4xl md:text-5xl lg:text-6xl font-semibold text-white/90 leading-tight mb-12 max-w-2xl mx-auto">
                <!-- Task inserted here -->
            </div>

            <!-- Flow State Timer -->
            <div class="flex flex-col items-center justify-center mb-12 relative w-64 h-64 mx-auto">
                <div class="breathing-circle"></div>
                <!-- z-index to stay above the breathing circle -->
                <div class="relative z-10 flex flex-col items-center justify-center h-full">
                    <div id="flow-display"
                        class="text-5xl md:text-7xl font-light tracking-widest text-white/90 mb-2 font-mono drop-shadow-lg">
                    </div>
                    <div id="zen-flow-text" class="text-xs tracking-[0.2em] text-white/30 uppercase hidden">Time in Flow
                    </div>
                </div>
            </div>

            <div class="flex space-x-4 justify-center mb-12">
                <button id="flow-toggle"
                    class="px-8 glass py-3 rounded-full text-lg font-medium hover:bg-white/10 transition-colors text-white/90 border-white/10 relative z-10">
                    Enter Flow
                </button>
                <button id="flow-reset"
                    class="px-6 glass py-3 rounded-full text-lg font-medium hover:bg-white/10 transition-colors text-white/60 border-white/10 relative z-10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                </button>
            </div>

            <button id="zen-complete-btn"
                class="glass px-8 py-3 rounded-full font-medium text-white/80 hover:text-white hover:bg-white/10 transition-colors border-white/10 hidden mx-auto">
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Mark Complete
            </button>
        </div>
    </div>

    <!-- Hidden Authentication Modal -->
    <div id="auth-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="glass-card p-8 rounded-2xl max-w-md w-full text-center">
            <h2 class="text-xl font-bold mb-4">Google Authentication Required</h2>
            <p class="text-sm text-white/70 mb-6">Personal-OS needs permission to read your Calendar and Gmail to
                populate the dashboard.</p>
            <a id="auth-link" href="#" target="_blank"
                class="inline-block bg-white text-black font-medium px-6 py-3 rounded-full hover:bg-gray-200 transition mb-6">Authorize
                with Google</a>

            <div class="text-left mt-4 border-t border-white/10 pt-4">
                <p class="text-xs text-white/50 mb-2">After authorizing, paste the code here:</p>
                <div class="flex space-x-2">
                    <input type="text" id="auth-code-input"
                        class="flex-grow bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-soft-amber"
                        placeholder="Paste code...">
                    <button id="submit-auth-code"
                        class="bg-soft-amber/20 text-soft-amber border border-soft-amber/30 px-4 py-2 rounded-lg text-sm hover:bg-soft-amber/30 transition">Submit</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Application Logic -->
    <script>
        const API_BASE = '/api';

        let localTasks = [];

        // --- DOM Elements ---
        const authStatusEl = document.getElementById('auth-status');
        const authModal = document.getElementById('auth-modal');
        const authLink = document.getElementById('auth-link');
        const authCodeInput = document.getElementById('auth-code-input');
        const submitAuthCodeBtn = document.getElementById('submit-auth-code');
        const zenToggle = document.getElementById('zen-toggle');

        // --- Context Theme Handling ---
        const contextProfBtn = document.getElementById('context-professional');
        const contextPersBtn = document.getElementById('context-personal');
        // --- Agent Alpha (Temporal Logic) ---
        function getAutoContext() {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            if (day === 0 || day === 6 || hour >= 18 || hour < 8) {
                return 'personal';
            }
            return 'professional';
        }
        let currentContext = getAutoContext(); // dynamic default state

        function updateContextTheme(context, isInitialLoad = false) {
            if (currentContext === context && !isInitialLoad) return;
            currentContext = context;

            // Smooth data transition
            if (mainLayout && !isInitialLoad) {
                mainLayout.style.opacity = '0.3';
                mainLayout.style.transform = 'scale(0.99)';
                setTimeout(() => {
                    // Hard clear the DOM arrays so they physically wipe out before the refetch completes
                    localTasks = [];
                    globalCalendarEvents = [];
                    document.getElementById('inbox-container').innerHTML = '<div class="text-sm text-white/40 italic">Syncing context...</div>';
                    document.getElementById('list-doing').innerHTML = '';
                    document.getElementById('list-todo').innerHTML = '';
                    document.getElementById('trips-container').innerHTML = '<div class="text-sm text-white/40 italic">Syncing context...</div>';
                    document.getElementById('rituals-container').innerHTML = '<div class="text-sm text-white/40 italic">Syncing context...</div>';

                    loadDashboardData();
                    setTimeout(() => {
                        mainLayout.style.opacity = '1';
                        mainLayout.style.transform = 'scale(1)';
                    }, 100);
                }, 400);
            }

            if (context === 'personal') {
                document.body.classList.add('theme-personal');

                // Active state styling for Personal
                contextPersBtn.classList.add('bg-white/10', 'text-white/90');
                contextPersBtn.classList.remove('text-white/40', 'hover:text-white/70');

                // Inactive state styling for Professional
                contextProfBtn.classList.remove('bg-white/10', 'text-white/90');
                contextProfBtn.classList.add('text-white/40', 'hover:text-white/70');
            } else {
                document.body.classList.remove('theme-personal');

                // Active state styling for Professional
                contextProfBtn.classList.add('bg-white/10', 'text-white/90');
                contextProfBtn.classList.remove('text-white/40', 'hover:text-white/70');

                // Inactive state styling for Personal
                contextPersBtn.classList.remove('bg-white/10', 'text-white/90');
                contextPersBtn.classList.add('text-white/40', 'hover:text-white/70');
            }
        }

        contextProfBtn.addEventListener('click', () => updateContextTheme('professional'));
        contextPersBtn.addEventListener('click', () => updateContextTheme('personal'));

        // --- Zen Mode Handle ---
        let isZenMode = false;
        const mainLayout = document.getElementById('main-layout');
        const zenLayout = document.getElementById('zen-layout');
        const zenTaskDisplay = document.getElementById('zen-task-display');
        let currentZenTaskId = null;

        function updateZenDisplay() {
            const doingTasks = localTasks.filter(t => t.status === 'doing');
            if (doingTasks.length > 0) {
                zenTaskDisplay.textContent = doingTasks[0].title;
                currentZenTaskId = doingTasks[0].id;
                document.getElementById('zen-complete-btn').classList.remove('hidden');
            } else {
                zenTaskDisplay.textContent = "Breathe. You have no active focus.";
                currentZenTaskId = null;
                document.getElementById('zen-complete-btn').classList.add('hidden');
            }
        }

        zenToggle.addEventListener('click', () => {
            isZenMode = !isZenMode;
            if (isZenMode) {
                document.body.classList.add('zen-active');

                mainLayout.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                mainLayout.classList.remove('opacity-100', 'scale-100');

                zenLayout.classList.remove('hidden');
                updateZenDisplay();
                // small delay for transition trigger
                setTimeout(() => zenLayout.classList.add('opacity-100'), 50);

                zenToggle.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Exit Zen</span>`;
            } else {
                document.body.classList.remove('zen-active');

                zenLayout.classList.remove('opacity-100');
                setTimeout(() => {
                    zenLayout.classList.add('hidden');
                    mainLayout.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                    mainLayout.classList.add('opacity-100', 'scale-100');
                }, 700);

                zenToggle.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <span>Enter Zen Mode</span>`;
            }
        });

        document.getElementById('zen-complete-btn').addEventListener('click', () => {
            if (currentZenTaskId) {
                const task = localTasks.find(t => t.id === currentZenTaskId);
                if (task) {
                    task.status = 'done';
                    saveTasks();
                    renderTasks();
                    updateZenDisplay();
                }
            }
        });
        // --- AbortController for Context Switching Race Conditions ---
        let activeControllers = {};
        function getSignal(key) {
            if (activeControllers[key]) activeControllers[key].abort();
            activeControllers[key] = new AbortController();
            return activeControllers[key].signal;
        }

        // --- Authentication Flow ---
        async function checkAuthAndFetch(endpoint, containerId, renderFn) {
            try {
                const signal = getSignal(endpoint);
                const res = await fetch(`${API_BASE}/${endpoint}?context=${currentContext}`, { signal });
                const data = await res.json();

                if (data.requiresAuth) {
                    showAuthModal();
                    return;
                }

                if (data.error) throw new Error(data.error);

                authStatusEl.textContent = '‚óè Google Connected';
                authStatusEl.className = 'text-sm font-medium px-4 py-2 rounded-full glass border-green-500/30 text-green-400 hide-in-zen cursor-default';
                authStatusEl.onclick = null;

                renderFn(data, document.getElementById(containerId));
            } catch (err) {
                if (err.name === 'AbortError') return;
                console.error(`Failed fetching ${endpoint}:`, err);
                document.getElementById(containerId).innerHTML = `<div class="text-red-400 text-sm p-4 bg-red-500/10 rounded-lg border border-red-500/20">Error: ${err.message}</div>`;
            }
        }

        async function showAuthModal() {
            authModal.classList.remove('hidden');
            try {
                const res = await fetch(`${API_BASE}/auth/url`);
                const data = await res.json();
                if (res.ok && data.url) {
                    authLink.href = data.url;
                    authLink.textContent = "Authorize with Google";
                    authLink.classList.remove('pointer-events-none', 'opacity-50');
                } else {
                    authLink.href = "#";
                    authLink.textContent = "Missing credentials.json";
                    authLink.classList.add('pointer-events-none', 'opacity-50');
                    if (!document.getElementById('auth-error-msg')) {
                        const err = document.createElement('p');
                        err.id = 'auth-error-msg';
                        err.className = 'text-xs text-red-400 mb-4 px-4';
                        err.textContent = `Error: ${data.error || 'Failed to load Auth URL.'} Please place your Google Cloud credentials.json in the project root.`;
                        authLink.parentNode.insertBefore(err, authLink);
                    }
                }
            } catch (err) {
                console.error('Auth URL Fetch Error:', err);
                authLink.textContent = "Backend Offline";
            }
        }

        submitAuthCodeBtn.addEventListener('click', async () => {
            const code = authCodeInput.value.trim();
            if (!code) return;

            try {
                submitAuthCodeBtn.textContent = 'Verifying...';
                submitAuthCodeBtn.disabled = true;
                const res = await fetch(`${API_BASE}/auth/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (data.success) {
                    authModal.classList.add('hidden');
                    loadDashboardData(); // Reload everything
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                alert('Authentication failed: ' + err.message);
            } finally {
                submitAuthCodeBtn.textContent = 'Submit';
                submitAuthCodeBtn.disabled = false;
            }
        });

        // --- Render Functions ---
        function renderCalendar(events, container) {
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="text-sm text-white/50 p-4">No events in the upcoming 30 days.</div>';
                return;
            }

            container.innerHTML = '';
            // Group by day roughly
            events.forEach(event => {
                const date = new Date(event.start);
                const isToday = new Date().toDateString() === date.toDateString();

                const timeStr = event.start.includes('T') ?
                    date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : 'All Day';

                const el = document.createElement('div');
                el.className = `p-3 rounded-lg border ${isToday ? 'bg-blue-500/10 border-blue-500/30' : 'glass border-white/5'} flex justify-between items-start cursor-grab active:cursor-grabbing hover:bg-white/5 transition-colors`;
                el.draggable = true;
                el.addEventListener('dragstart', (e) => {
                    el.style.opacity = '0.5';
                    e.dataTransfer.setData('text/plain', 'NEW_TASK:' + (event.summary || 'Busy'));
                });
                el.addEventListener('dragend', () => el.style.opacity = '1');
                el.innerHTML = `
                    <div>
                        <p class="font-medium text-sm text-white/90 leading-tight mb-1">${event.summary || 'Busy'}</p>
                        <p class="text-xs ${isToday ? 'text-blue-300' : 'text-white/50'}">${timeStr} ‚Ä¢ ${date.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' })}</p>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function renderInbox(messages, container) {
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div class="h-32 flex flex-col items-center justify-center text-white/40 space-y-3 animate-fade-in">
                        <svg class="w-8 h-8 text-green-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-[10px] tracking-[0.2em] font-medium uppercase">All clear.</span>
                    </div>
                `;
                return;
            }
            container.innerHTML = messages.map(msg => {
                const title = (msg.subject || 'Email').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <div class="inbox-item w-full p-3 bg-white/5 hover:bg-white/10 transition-colors rounded-lg border border-white/5 cursor-grab active:cursor-grabbing"
                     draggable="true" 
                     data-subject="${title}"
                     data-id="${msg.id}"
                     ontouchstart="this.classList.add('is-dragging');"
                     ontouchend="this.classList.remove('is-dragging');"
                     ontouchcancel="this.classList.remove('is-dragging');"
                     ondragstart="this.classList.add('is-dragging'); event.dataTransfer.setData('text/plain', 'NEW_TASK:' + '${title}');"
                     ondragend="this.classList.remove('is-dragging');">
                    <p class="text-xs font-semibold text-white/70 truncate mb-1">${msg.from}</p>
                    <p class="text-sm font-medium text-white/90 truncate">${msg.subject}</p>
                </div>
            `}).join('');
        }

        function renderTrips(groupedTrips, container) {
            if (!groupedTrips || groupedTrips.length === 0) {
                container.innerHTML = '<div class="text-sm text-white/50 p-4">No upcoming bookings found.</div>';
                return;
            }

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1]}`;
                }
                return dateStr;
            };

            container.innerHTML = groupedTrips.map((group, index) => {
                // Determine broad dates
                const startFormatted = formatDate(group.StartDate);
                const endFormatted = formatDate(group.EndDate);

                const dateRange = (group.StartDate && group.EndDate && group.StartDate !== group.EndDate)
                    ? `${startFormatted} - ${endFormatted}`
                    : startFormatted;

                const componentsHtml = (group.Components || []).map(comp => {
                    const isHotel = comp.Type.toLowerCase().includes('hotel');
                    const isTrain = comp.Type.toLowerCase().includes('train');
                    const textClass = isHotel ? 'text-teal-300' : (isTrain ? 'text-indigo-300' : 'text-emerald-300');
                    const icon = isHotel ? 'üè®' : (isTrain ? 'üöÜ' : '‚úàÔ∏è');

                    return `
                        <div class="mt-2 p-2 bg-white/5 rounded flex justify-between items-center group/comp">
                            <div>
                                <p class="text-xs font-semibold ${textClass} mb-0.5">${icon} ${comp.Title}</p>
                                <p class="text-[10px] text-white/50 uppercase tracking-widest">${comp.DateTime || 'TBA'}</p>
                            </div>
                            <div class="text-[10px] text-white/40 font-mono tracking-wider opacity-0 group-hover/comp:opacity-100 transition-opacity">
                                Ref: ${comp.ConfirmationCode || 'N/A'}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                <div class="trip-accordion glass bg-white/5 border border-white/10 rounded-xl mb-3 overflow-hidden cursor-pointer hover:bg-white/10 transition-colors">
                    <!-- Header -->
                    <div class="p-4 flex justify-between items-center select-none">
                        <div>
                            <p class="text-sm font-bold text-white/90 mb-0.5 flex items-center">
                                üó∫Ô∏è ${group.TripName}
                                <span class="ml-2 text-[10px] px-1.5 py-0.5 rounded-full bg-white/10 text-white/60 font-medium">${group.Components?.length || 0} items</span>
                            </p>
                            <p class="text-xs text-soft-amber font-medium">${dateRange}</p>
                        </div>
                        <svg class="trip-chevron w-5 h-5 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <!-- Details / Components -->
                    <div class="trip-accordion-content border-t border-white/5">
                        <div class="p-3 pt-1">
                            ${componentsHtml}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- Kanban Logic ---
        async function loadTasks() {
            try {
                const signal = getSignal('tasks');
                const res = await fetch(`${API_BASE}/tasks?context=${currentContext}`, { signal });
                localTasks = await res.json();
                renderTasks();
            } catch (err) {
                if (err.name === 'AbortError') return;
                console.error("Failed loading tasks", err);
            }
        }

        function saveTasks() {
            fetch(`${API_BASE}/tasks?context=${currentContext}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(localTasks)
            }).catch(console.error);
        }

        function renderTasks() {
            const todoList = document.getElementById('list-todo');
            const doingList = document.getElementById('list-doing');

            // Keep the "drag tasks here" placeholder if empty
            todoList.innerHTML = localTasks.filter(t => t.status === 'todo').length === 0 ? '<div class="text-sm text-white/30 italic text-center py-4">Drag tasks here</div>' : '';
            doingList.innerHTML = localTasks.filter(t => t.status === 'doing').length === 0 ? '<div class="text-sm text-white/30 italic text-center py-4">Drag tasks here</div>' : '';

            localTasks.forEach(task => {
                if (task.status === 'done') return; // Don't render done tasks in this minimal view

                const el = document.createElement('div');
                el.className = `task-item p-3 rounded-lg border border-white/10 ${task.status === 'doing' ? 'bg-soft-amber/10 border-soft-amber/30' : 'bg-white/5'}`;
                el.draggable = true;
                el.dataset.id = task.id;

                // Content
                const timeBadge = task.scheduledTime ? `<div class="mt-2 text-xs font-medium text-blue-300 bg-blue-500/10 inline-block px-2 py-0.5 rounded border border-blue-500/20">üìÖ ${new Date(task.scheduledTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })} - ${task.scheduledReasoning}</div>` : '';
                const loadingBadge = task.isScheduling ? `<div class="mt-2 text-xs font-medium text-soft-amber animate-pulse">‚ú® AI is finding a time...</div>` : '';

                el.innerHTML = `
                    <div class="flex items-start">
                        <input type="checkbox" class="task-checkbox mt-1 mr-3 w-4 h-4 rounded border-gray-600 bg-gray-700 text-soft-amber focus:ring-soft-amber/50 cursor-pointer" data-id="${task.id}">
                        <div class="flex-grow">
                            <p class="text-sm text-white/90 leading-snug">${task.title}</p>
                            ${loadingBadge}
                            ${timeBadge}
                        </div>
                    </div>
                `;

                // Hover tracking for "X" auto-schedule
                el.addEventListener('mouseenter', () => hoveredTaskId = task.id);
                el.addEventListener('mouseleave', () => hoveredTaskId = null);

                // Drag Events
                el.addEventListener('dragstart', (e) => {
                    el.classList.add('dragging', 'is-dragging');
                    e.dataTransfer.setData('text/plain', task.id);
                });
                el.addEventListener('dragend', () => el.classList.remove('dragging', 'is-dragging'));

                // Explicit Touch events for Mobile Polyfill Haptics
                el.addEventListener('touchstart', () => el.classList.add('is-dragging'), { passive: true });
                el.addEventListener('touchend', () => el.classList.remove('is-dragging'), { passive: true });
                el.addEventListener('touchcancel', () => el.classList.remove('is-dragging'), { passive: true });

                // Checkbox event (Mark Done)
                const cb = el.querySelector('.task-checkbox');
                cb.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        el.style.opacity = '0.5';
                        el.style.textDecoration = 'line-through';
                        setTimeout(() => {
                            const t = localTasks.find(t => t.id === task.id);
                            if (t) t.status = 'done';
                            saveTasks();
                            renderTasks();
                        }, 500);
                    }
                });

                if (task.status === 'todo') todoList.appendChild(el);
                if (task.status === 'doing') doingList.appendChild(el);
            });
        }

        // Set up Drag and Drop Zones
        document.querySelectorAll('.kanban-dropzone').forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const dragData = e.dataTransfer.getData('text/plain');
                const newStatus = zone.dataset.status;

                // Handle Dropped External Item (Email or Calendar Event)
                if (dragData.startsWith('NEW_TASK:')) {
                    const title = dragData.substring(9);
                    localTasks.push({ id: Date.now().toString(), title, status: newStatus });
                    saveTasks();
                    renderTasks();
                    return;
                }

                // Handle Existing Kanban Task Move
                const task = localTasks.find(t => t.id === dragData);
                if (task && task.status !== newStatus) {
                    task.status = newStatus;
                    saveTasks();
                    renderTasks();
                    if (newStatus === 'doing' && isZenMode) updateZenDisplay();
                }
            });
        });

        // Quick Add Task Form
        const quickAddForm = document.getElementById('quick-add-form');
        const quickAddInput = document.getElementById('quick-add-input');
        if (quickAddForm && quickAddInput) {
            quickAddForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = quickAddInput.value.trim();
                if (title) {
                    localTasks.push({ id: Date.now().toString(), title, status: 'todo' });
                    saveTasks();
                    renderTasks();
                    quickAddInput.value = '';
                }
            });
        }

        // --- Sunsama Global Hotkeys (A = Add Task, X = Auto-Schedule) ---
        let hoveredTaskId = null;
        let globalCalendarEvents = []; // Cache for AI scheduler

        document.addEventListener('keydown', async (e) => {
            // Ignore if typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // 'A' to Quick Add
            if (e.key.toLowerCase() === 'a') {
                e.preventDefault();
                quickAddInput.focus();
            }

            // 'X' to Auto-Schedule hovered task
            if (e.key.toLowerCase() === 'x' && hoveredTaskId) {
                e.preventDefault();
                const task = localTasks.find(t => t.id === hoveredTaskId);
                if (task && !task.isScheduling) {
                    task.isScheduling = true;
                    renderTasks(); // Show loading state

                    try {
                        const res = await fetch(`${API_BASE}/ai/schedule`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                taskTitle: task.title,
                                calendarEvents: globalCalendarEvents
                            })
                        });

                        const suggestion = await res.json();
                        if (suggestion.error) throw new Error(suggestion.error);

                        task.scheduledTime = suggestion.recommendedTime;
                        task.scheduledReasoning = suggestion.reasoning;
                    } catch (err) {
                        console.error('AI Auto-Schedule failed:', err);
                        alert('Could not auto-schedule: ' + err.message);
                    } finally {
                        task.isScheduling = false;
                        saveTasks();
                        renderTasks();
                    }
                }
            }
        });

        // --- Phase 28 & 29 Data Loaders (Rituals & Notes) ---
        async function loadRituals() {
            try {
                const signal = getSignal('rituals');
                const res = await fetch(`${API_BASE}/rituals`, { signal });
                if (!res.ok) throw new Error('Failed to fetch rituals');
                const rituals = await res.json();

                const container = document.getElementById('rituals-container');
                container.innerHTML = '';

                const allCompleted = rituals.length > 0 && rituals.every(r => r.completed);
                if (rituals.length === 0 || allCompleted) {
                    container.innerHTML = `
                        <div class="h-24 flex flex-col items-center justify-center text-white/40 space-y-2 animate-fade-in">
                            <svg class="w-6 h-6 text-green-400/50 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="text-[10px] tracking-[0.2em] font-medium uppercase">All clear.</span>
                        </div>
                    `;
                    return;
                }

                rituals.forEach(ritual => {
                    const el = document.createElement('div');
                    el.className = `group flex items-center justify-between p-2 rounded-lg transition-colors hover:bg-white/5 ${ritual.completed ? 'opacity-50' : 'opacity-100'}`;
                    el.innerHTML = `
                        <label class="flex items-center space-x-3 cursor-pointer flex-1">
                            <input type="checkbox" class="form-checkbox h-4 w-4 rounded border-gray-600 bg-gray-700 text-pink-500 focus:ring-pink-500/50 cursor-pointer" 
                                ${ritual.completed ? 'checked' : ''} onchange="toggleRitual('${ritual.id}', this.checked)">
                            <span class="text-sm text-white/90 ${ritual.completed ? 'line-through text-white/50' : ''}">${ritual.title}</span>
                        </label>
                        <button onclick="deleteRitual('${ritual.id}')" class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-300 transition-opacity p-1" title="Delete Ritual">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    `;
                    container.appendChild(el);
                });
            } catch (err) {
                if (err.name === 'AbortError') return;
                console.error("Rituals load error:", err);
            }
        }

        async function toggleRitual(id, completed) {
            try {
                await fetch(`${API_BASE}/rituals/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed })
                });
                loadRituals(); // Reload to refresh visually and safely
            } catch (err) {
                console.error("Rituals toggle error:", err);
            }
        }

        async function addRitual() {
            const title = prompt("Enter new daily ritual:");
            if (!title || !title.trim()) return;
            try {
                await fetch(`${API_BASE}/rituals`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title.trim(), context_mode: currentContext })
                });
                loadRituals();
            } catch (err) {
                console.error("Failed to add ritual:", err);
            }
        }

        async function deleteRitual(id) {
            if (!confirm("Delete this daily ritual?")) return;
            try {
                await fetch(`${API_BASE}/rituals/${id}`, { method: 'DELETE' });
                loadRituals();
            } catch (err) {
                console.error("Failed to delete ritual:", err);
            }
        }

        async function loadNotes() {
            try {
                const signal = getSignal('notes');
                const res = await fetch(`${API_BASE}/notes?context=${currentContext}`, { signal });
                const data = await res.json();
                if (data && data.content !== undefined) {
                    document.getElementById('quick-notes-area').value = data.content;
                }
            } catch (err) {
                if (err.name === 'AbortError') return;
                console.error("Notes load error:", err);
            }
        }

        // Auto-Save Notes (Debounced)
        const notesArea = document.getElementById('quick-notes-area');
        const saveStatus = document.getElementById('notes-save-status');
        let notesTimeout;

        if (notesArea) {
            notesArea.addEventListener('input', () => {
                clearTimeout(notesTimeout);
                saveStatus.classList.remove('opacity-100'); // Hide saved status
                notesTimeout = setTimeout(async () => {
                    try {
                        const content = notesArea.value;
                        await fetch(`${API_BASE}/notes?context=${currentContext}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ content })
                        });
                        saveStatus.classList.add('opacity-100'); // Show saved status
                        setTimeout(() => saveStatus.classList.remove('opacity-100'), 2000);
                    } catch (err) { console.error("Notes save error:", err); }
                }, 1000); // Save 1s after last keystroke
            });
        }

        // --- Flow State Timer Logic ---
        let flowTimer = null;
        let flowTimeAccumulated = 0; // tracking accumulated time in ms when paused
        let flowStartTime = null;
        let isFlowActive = false;

        function getFlowTimeSeconds() {
            if (isFlowActive) {
                return Math.floor((flowTimeAccumulated + (Date.now() - flowStartTime)) / 1000);
            }
            return Math.floor(flowTimeAccumulated / 1000);
        }

        const flowDisplay = document.getElementById('flow-display');
        const flowToggle = document.getElementById('flow-toggle');
        const flowReset = document.getElementById('flow-reset');
        const pomodoroStats = document.getElementById('pomodoro-stats'); // Keeping ID same for backend reuse

        async function fetchPomodoroStats() {
            try {
                const signal = getSignal('pomodoros');
                const res = await fetch(`${API_BASE}/pomodoros/stats`, { signal });
                const data = await res.json();

                // Update Today Text
                const todayHours = Math.floor((data.today || 0) / 60);
                const todayMins = (data.today || 0) % 60;
                if (todayHours > 0) {
                    pomodoroStats.textContent = `${todayHours}h ${todayMins}m TODAY`;
                } else {
                    pomodoroStats.textContent = `${todayMins}m TODAY`;
                }

                // Render Heatmap Bars
                const heatmapContainer = document.getElementById('focus-heatmap-container');
                if (heatmapContainer && data.heatmap) {
                    heatmapContainer.innerHTML = '';
                    const MAX_EXPECTED_MINS = 240; // 4 hours cap for 100% bar height

                    data.heatmap.forEach((dayData, index) => {
                        const dayName = new Date(dayData.date).toLocaleDateString('en-US', { weekday: 'short' }).charAt(0);
                        const intensity = Math.min((dayData.minutes / MAX_EXPECTED_MINS) * 100, 100);

                        // Height constraint & baseline visibility
                        const barHeightClass = intensity > 0 ? `h-[${intensity}%]` : 'h-1';

                        const el = document.createElement('div');
                        el.className = "flex flex-col items-center justify-end w-full h-full group relative cursor-pointer";

                        // Tooltip
                        const hrs = Math.floor(dayData.minutes / 60);
                        const mins = dayData.minutes % 60;
                        const timeStr = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;

                        el.innerHTML = `
                            <div class="absolute -top-8 bg-charcoal border border-white/10 text-white/90 text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10 pointer-events-none">
                                ${new Date(dayData.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}: ${timeStr}
                            </div>
                            <div class="w-full bg-soft-amber transition-all duration-500 rounded-t-sm ${dayData.minutes > 0 ? 'opacity-80 group-hover:opacity-100' : 'opacity-20'}" 
                                 style="height: ${Math.max(intensity, 5)}%"></div>
                            <span class="text-[9px] text-white/30 mt-1 uppercase font-medium">${dayName}</span>
                        `;
                        heatmapContainer.appendChild(el);
                    });
                }
            } catch (err) {
                if (err.name === 'AbortError') return;
                console.error("Failed to fetch focus stats", err);
            }
        }

        function updateFlowDisplay() {
            const flowText = document.getElementById('zen-flow-text');
            if (!isFlowActive) {
                flowDisplay.textContent = "";
                if (flowText) flowText.classList.add('hidden');
                return;
            } else {
                if (flowText) flowText.classList.remove('hidden');
            }

            const totalSeconds = getFlowTimeSeconds();
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            flowDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Update document title for background tracking
            if (isFlowActive) {
                document.title = `[${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}] Flow State`;
            } else {
                document.title = "Personal OS v2.0";
            }
        }

        async function flowComplete() {
            // Log session if significant time passed (e.g. >= 1 minute)
            const totalSeconds = getFlowTimeSeconds();
            if (totalSeconds >= 60) {
                const minutesFocused = Math.floor(totalSeconds / 60);
                try {
                    await fetch(`${API_BASE}/pomodoros`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ duration_minutes: minutesFocused })
                    });
                    fetchPomodoroStats();
                } catch (err) {
                    console.error("Failed to log flow session", err);
                }
            }
        }

        function toggleFlowState() {
            if (isFlowActive) {
                // Pause
                clearInterval(flowTimer);
                flowTimeAccumulated += (Date.now() - flowStartTime);
                isFlowActive = false;
                flowComplete(); // Log time on pause
                flowToggle.textContent = 'Resume Flow';
                flowToggle.classList.remove('bg-white/20');
                flowToggle.classList.add('glass');
                document.querySelector('.breathing-circle').style.animationPlayState = 'paused';
                updateFlowDisplay();
            } else {
                // Start
                isFlowActive = true;
                flowStartTime = Date.now();
                flowToggle.textContent = 'Pause Flow';
                flowToggle.classList.remove('glass');
                flowToggle.classList.add('bg-white/20');
                document.querySelector('.breathing-circle').style.animationPlayState = 'running';
                updateFlowDisplay();

                flowTimer = setInterval(() => {
                    updateFlowDisplay();
                }, 1000);
            }
        }

        flowToggle.addEventListener('click', toggleFlowState);
        flowReset.addEventListener('click', () => {
            clearInterval(flowTimer);
            if (isFlowActive) {
                flowComplete(); // log remaining time
            }
            isFlowActive = false;
            flowTimeAccumulated = 0;
            flowStartTime = null;
            updateFlowDisplay();
            flowToggle.textContent = 'Enter Flow';
            flowToggle.classList.remove('bg-white/20');
            flowToggle.classList.add('glass');
            document.querySelector('.breathing-circle').style.animationPlayState = 'paused';
        });

        // Pause animation by default
        document.querySelector('.breathing-circle').style.animationPlayState = 'paused';

        // --- Initialization & Background Sync ---
        function loadDashboardData() {
            loadTasks();
            loadRituals();
            loadNotes();
            fetchPomodoroStats();
            fetchGoogleData();
        }

        function fetchGoogleData() {
            // Re-fetch calendar events
            checkAuthAndFetch('calendar', 'calendar-container', (data, container) => {
                globalCalendarEvents = data;
                renderCalendar(data, container);
            });

            // Re-fetch unread emails
            if (currentContext === 'professional') {
                document.getElementById('inbox-container').innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center space-y-3 p-4 text-center animate-fade-in">
                        <svg class="w-8 h-8 text-blue-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
                        </svg>
                        <div>
                            <p class="text-[11px] font-semibold text-white/70 tracking-wider uppercase mb-1">Office 365</p>
                            <p class="text-xs text-white/50 leading-relaxed max-w-[200px] mx-auto">Connect <span class="text-white/70">sabrina.carmona@supercell.com</span> to sync your work inbox.</p>
                        </div>
                        <button class="mt-2 text-[10px] font-semibold tracking-wider text-blue-400 bg-blue-500/10 hover:bg-blue-500/20 px-4 py-2 rounded-full transition-colors uppercase border border-blue-500/20" id="office365-btn">Connect Account</button>
                    </div>
                `;
            } else {
                checkAuthAndFetch('inbox', 'inbox-container', renderInbox);
            }

            // Intelligent Trips loading with auto-retry
            let tripAttempts = 0;
            let tripInterval;

            function fetchTripsLogic() {
                checkAuthAndFetch('trips', 'trips-container', (data, container) => {
                    renderTrips(data, container);
                    if (data && data.length > 0) {
                        if (tripInterval) clearInterval(tripInterval);
                    } else if (tripAttempts < 5) {
                        tripAttempts++;
                        container.innerHTML = '<div class="text-sm text-white/40 italic p-4 relative overflow-hidden"><div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full animate-[shimmer_2s_infinite]"></div>Parsing travel data...</div>';
                    } else {
                        if (tripInterval) clearInterval(tripInterval);
                    }
                });
            }

            fetchTripsLogic(); // Initial fetch
            tripInterval = setInterval(fetchTripsLogic, 4000);

            // Flash the auth pill briefly to indicate a background sync occurred
            if (authStatusEl.textContent.includes('Connected')) {
                authStatusEl.classList.add('bg-green-500/20');
                setTimeout(() => authStatusEl.classList.remove('bg-green-500/20'), 1000);
            }

            // Update Last Synced timestamp
            const now = new Date();
            const syncTime = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
            document.getElementById('hud-last-sync').textContent = `SYNCED: ${syncTime}`;
        }

        // --- Context HUD (Time & Weather) ---
        function updateHUDClock() {
            const now = new Date();
            const dateEl = document.getElementById('hud-date');
            const timeEl = document.getElementById('hud-time');

            // Format: "Wed 11 Mar"
            dateEl.textContent = now.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });

            // Format: "14:05" (24-hour)
            timeEl.textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        async function fetchHUDWeather() {
            const weatherEl = document.getElementById('hud-weather');
            try {
                // Fetch London weather
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.5085&longitude=-0.1257&current=temperature_2m,weather_code');
                const data = await response.json();

                const temp = Math.round(data.current.temperature_2m);
                const code = data.current.weather_code;

                let emoji = 'üå§Ô∏è';
                if (code === 0) emoji = '‚òÄÔ∏è';
                else if (code >= 1 && code <= 3) emoji = '‚òÅÔ∏è';
                else if (code >= 45 && code <= 48) emoji = 'üå´Ô∏è';
                else if (code >= 51 && code <= 67) emoji = 'üåßÔ∏è';
                else if (code >= 71 && code <= 77) emoji = '‚ùÑÔ∏è';
                else if (code >= 80 && code <= 82) emoji = 'üå¶Ô∏è';
                else if (code >= 95) emoji = '‚ö°';

                weatherEl.innerHTML = `${emoji} ${temp}&deg;C`;
            } catch (err) {
                console.error("Failed to fetch weather", err);
                weatherEl.textContent = '--¬∞C';
            }
        }

        // Start App on Initial Load
        updateContextTheme(currentContext, true); // Initialize context buttons visually
        loadDashboardData();
        updateHUDClock();
        fetchHUDWeather();
        setInterval(updateHUDClock, 1000); // Tick clock every second
        setInterval(fetchHUDWeather, 15 * 60 * 1000); // Fetch weather every 15 mins

        // Start Background Polling (Every 60 seconds)
        // Fixed: Use Visibility API to prevent strict 60s jitter when tab is hidden
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'visible') {
                fetchGoogleData();
            }
        });

        // Slower fallback poll (5 mins) instead of aggressive 60s
        setInterval(fetchGoogleData, 300000);

        // --- MailCraft Agent Logic ---
        const TONES = ['professional', 'warm', 'concise', 'friendly', 'formal', 'persuasive', 'apologetic', 'grateful'];
        let activeMailCraftTone = 'professional';
        let mailCraftAbortController = null;

        function renderMailCraftTones() {
            const container = document.getElementById('mailcraft-tones-container');
            container.innerHTML = TONES.map(tone => {
                const isActive = tone === activeMailCraftTone;
                const activeStyle = isActive
                    ? `border-color: rgba(255,255,255,0.9); color: #ffffff; background: rgba(255,255,255,0.05);`
                    : `border-color: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); background: rgba(0,0,0,0.2);`;
                return `
                    <button data-tone="${tone}" 
                            class="mailcraft-tone-btn glass-card text-[13px] capitalize px-4 py-2 flex items-center justify-center rounded-xl border transition-all duration-200 font-semibold tracking-wide hover:bg-white/10 focus:outline-none flex-grow-0"
                            style="${activeStyle}">
                        ${tone}
                    </button>
                `;
            }).join('');

            document.getElementById('mailcraft-selected-tone-label').textContent = activeMailCraftTone.toUpperCase();
        }

        function setMailCraftTone(tone) {
            activeMailCraftTone = tone;
            renderMailCraftTones();
        }

        function openMailCraft(el) {
            const subject = el.getAttribute('data-subject');
            const messageId = el.getAttribute('data-id');
            document.getElementById('mailcraft-reply-context').value = subject;
            document.getElementById('mailcraft-reply-message-id').value = messageId || '';
            document.getElementById('mailcraft-context-label').innerHTML = `REPLYING TO: <span class="font-bold text-white normal-case ml-2 text-[11px]">${subject}</span>`;

            // Toggle Panes Dynamically
            document.getElementById('quick-notes-panel').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('quick-notes-panel').classList.remove('opacity-100', 'pointer-events-auto');
            document.getElementById('quick-notes-panel').style.zIndex = '0';

            document.getElementById('mailcraft-panel').classList.add('opacity-100', 'pointer-events-auto');
            document.getElementById('mailcraft-panel').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('mailcraft-panel').style.zIndex = '10';

            // Reset Output and Buttons
            document.getElementById('mailcraft-send-btn').style.display = 'flex';
            document.getElementById('mailcraft-send-btn').disabled = false;
            document.getElementById('mailcraft-send-btn').innerHTML = `Send <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`;

            renderMailCraftTones();
        }

        function closeMailCraft() {
            if (mailCraftAbortController) {
                mailCraftAbortController.abort();
            }

            document.getElementById('mailcraft-panel').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('mailcraft-panel').classList.remove('opacity-100', 'pointer-events-auto');
            document.getElementById('mailcraft-panel').style.zIndex = '0';

            document.getElementById('quick-notes-panel').classList.add('opacity-100', 'pointer-events-auto');
            document.getElementById('quick-notes-panel').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('quick-notes-panel').style.zIndex = '10';

            // Cleanup
            document.getElementById('mailcraft-draft-text').value = '';
            document.getElementById('mailcraft-output-container').classList.add('hidden');
            document.getElementById('mailcraft-output-text').textContent = '';
        }

        async function generateMailCraft() {
            const draftText = document.getElementById('mailcraft-draft-text').value.trim();
            const replyContext = document.getElementById('mailcraft-reply-context').value;
            const outputContainer = document.getElementById('mailcraft-output-container');
            const outputText = document.getElementById('mailcraft-output-text');
            const genBtn = document.getElementById('mailcraft-generate-btn');

            if (!draftText) return alert("Please provide some rough thoughts first.");

            // Garbage Collection (Agent Gamma requirement)
            if (mailCraftAbortController) mailCraftAbortController.abort();
            mailCraftAbortController = new AbortController();

            outputContainer.classList.remove('hidden');
            outputContainer.classList.add('flex');
            outputText.textContent = '';
            genBtn.disabled = true;
            genBtn.innerHTML = '<span class="animate-pulse">Writing...</span>';

            try {
                const response = await fetch(`${API_BASE}/mailcraft`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ draftText, tone: activeMailCraftTone, replyContext }),
                    signal: mailCraftAbortController.signal
                });

                if (!response.ok) throw new Error("Failed to connect to backend stream");

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let streamingText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataPayload = line.replace('data: ', '').trim();
                            if (dataPayload === '[DONE]') break;
                            let parsed;
                            try {
                                parsed = JSON.parse(dataPayload);
                            } catch (e) {
                                // Ignore parse errors for split chunks, will combine on next read
                                continue;
                            }

                            if (parsed.error) {
                                throw new Error(parsed.error);
                            }
                            if (parsed.text) {
                                streamingText += parsed.text;
                                outputText.textContent = streamingText;
                                // Auto scroll
                                outputText.scrollTop = outputText.scrollHeight;
                            }
                        }
                    }
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error("MailCraft error:", err);
                    let displayMeta = err.message;

                    // The Gemini SDK often passes deeply stringified JSON errors instead of flat text.
                    // We attempt to parse it cleanly, otherwise fallback to the raw message.
                    try {
                        let innerObj = JSON.parse(err.message);
                        if (innerObj.error && innerObj.error.message) {
                            let deepObj = JSON.parse(innerObj.error.message);
                            if (deepObj.error && deepObj.error.message) {
                                displayMeta = deepObj.error.message;
                            }
                        } else if (innerObj.error) {
                            displayMeta = innerObj.error;
                        }
                    } catch (e) { /* use raw */ }

                    // Make the error UI look more native
                    outputText.innerHTML = `<span class="text-red-400 font-semibold mb-1 block">API Connection Error</span><span class="text-white/60 text-xs">${displayMeta}</span>`;
                }
            } finally {
                genBtn.disabled = false;
                genBtn.innerHTML = `Generate Draft <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>`;
            }
        }

        async function copyMailCraftOutput() {
            const textToCopy = document.getElementById('mailcraft-output-text').textContent;
            await navigator.clipboard.writeText(textToCopy);

            const copyBtn = document.getElementById('mailcraft-copy-btn');
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = `Copied! <svg class="w-3 h-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            copyBtn.classList.add('text-green-400', 'bg-green-400/10');

            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                copyBtn.classList.remove('text-green-400', 'bg-green-400/10');
            }, 2000);
        }

        async function sendMailCraftReply() {
            const messageId = document.getElementById('mailcraft-reply-message-id').value;
            const draftText = document.getElementById('mailcraft-output-text').textContent;
            const sendBtn = document.getElementById('mailcraft-send-btn');

            if (!messageId || !draftText) {
                alert("Missing draft content or original email ID.");
                return;
            }

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="animate-pulse">Sending...</span>';

            try {
                const res = await fetch(`${API_BASE}/mailcraft/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ replyToMessageId: messageId, payloadText: draftText })
                });

                const data = await res.json();
                if (data.success) {
                    sendBtn.innerHTML = `Sent! <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    setTimeout(() => {
                        closeMailCraft();
                        fetchGoogleData(); // Refresh the inbox
                    }, 1500);
                } else {
                    throw new Error(data.error || "Failed to send");
                }
            } catch (err) {
                alert("Failed to send reply: " + err.message);
                sendBtn.disabled = false;
                sendBtn.innerHTML = `Send <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>`;
            }
        }


        // --- Event Delegation for CSP Compliance ---
        // Instead of inline onclick attributes which are blocked by Helmet, we use delegated listeners
        document.addEventListener('click', (e) => {
            // Handle Trip Accordion Toggle
            const tripAccordion = e.target.closest('.trip-accordion');
            if (tripAccordion) {
                tripAccordion.classList.toggle('expanded');
                return; // Stop processing
            }

            // Handle Inbox Item MailCraft Open
            const inboxItem = e.target.closest('.inbox-item');
            if (inboxItem) {
                openMailCraft(inboxItem);
                return;
            }

            // Handle MailCraft Dynamic Tones
            const toneBtn = e.target.closest('.mailcraft-tone-btn');
            if (toneBtn) {
                setMailCraftTone(toneBtn.getAttribute('data-tone'));
                return;
            }

            // Fixed Buttons via ID matching
            const targetId = e.target.closest('button')?.id || e.target.id;
            switch (targetId) {
                case 'auth-status':
                    showAuthModal();
                    break;
                case 'close-mailcraft-btn':
                    closeMailCraft();
                    break;
                case 'mailcraft-generate-btn':
                    generateMailCraft();
                    break;
                case 'mailcraft-copy-btn':
                    copyMailCraftOutput();
                    break;
                case 'mailcraft-send-btn':
                    sendMailCraftReply();
                    break;
                case 'office365-btn':
                    alert('Office 365 integration coming soon!');
                    break;
            }
        });

    </script>
</body>

</html>