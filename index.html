<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal-OS v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        charcoal: '#121212',
                        'neon-indigo': '#4f46e5',
                        'soft-amber': '#f59e0b',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Specific drag n drop styles not handled by tailwind */
        .task-item.dragging {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.1);
        }

        .kanban-dropzone.drag-over {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="min-h-screen relative flex flex-col items-center py-8 px-4 sm:px-6 lg:px-8">
    <div class="ambient-glow-subtle hide-in-zen"></div>

    <!-- Top Navigation & Zen Toggle -->
    <div
        class="w-full max-w-[1400px] flex justify-between items-center mb-10 transition-all duration-700 relative z-50">
        <h1 class="text-2xl font-bold tracking-tight text-white/90 hide-in-zen transition-opacity duration-500">
            Sabrina's <span class="text-soft-amber">Control Centre</span></h1>

        <!-- Center Context Widget (HUD) -->
        <div id="header-hud"
            class="hidden md:flex flex-col items-center justify-center text-white/60 hide-in-zen transition-opacity duration-500 cursor-default">
            <div class="flex items-center space-x-3 text-sm font-medium tracking-wide">
                <span id="hud-date" class="uppercase text-white/50 text-xs">Loading Date...</span>
                <span class="w-1 h-1 rounded-full bg-white/20"></span>
                <span id="hud-time" class="text-white/80 font-bold text-lg">--:--</span>
                <span class="w-1 h-1 rounded-full bg-white/20"></span>
                <span id="hud-weather" class="flex items-center">
                    <svg class="w-4 h-4 animate-pulse mr-1" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                </span>
            </div>
            <div id="hud-location" class="text-[10px] text-white/30 tracking-widest uppercase mt-0.5">London, UK</div>
        </div>

        <div class="flex items-center space-x-6">
            <!-- Auth Status -->
            <div id="auth-status"
                class="text-sm font-medium px-4 py-2 rounded-full glass border-red-500/30 text-red-400 hide-in-zen transition-opacity duration-500">
                Google Not Connected
            </div>

            <!-- Zen Mode Toggle -->
            <button id="zen-toggle"
                class="glass px-6 py-2 rounded-full font-medium text-sm hover:bg-white/10 transition-colors flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                    </path>
                </svg>
                <span>Enter Zen Mode</span>
            </button>
        </div>
    </div>

    <!-- Main Sunsama 3-Column Layout -->
    <div id="main-layout"
        class="w-full max-w-[1400px] grid grid-cols-1 lg:grid-cols-12 gap-6 h-[80vh] transition-all duration-700 opacity-100 scale-100">

        <!-- Column 1: Actionable Inbox -->
        <div class="lg:col-span-3 flex flex-col space-y-6 h-full hide-in-zen transition-all-slow">
            <div class="rounded-2xl p-5 glass-card flex-grow overflow-hidden flex flex-col">
                <div class="mb-4">
                    <h2 class="text-md font-semibold flex items-center text-white/90 mb-1">
                        <svg class="w-5 h-5 mr-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                            </path>
                        </svg>
                        Actionable Inbox
                    </h2>
                    <p class="text-xs text-white/50 ml-7 leading-tight">Drag unread emails to create follow-up tasks</p>
                </div>
                <div id="inbox-container" class="flex-grow overflow-y-auto pr-2 space-y-3">
                    <div class="text-sm text-white/40 italic">Loading messages...</div>
                </div>
            </div>
        </div>

        <!-- Column 2: Tasks & Upcoming Trips Stacked -->
        <div class="lg:col-span-6 flex flex-col space-y-6 h-[80vh] hide-in-zen transition-all-slow">
            <!-- Tasks (Top Half) -->
            <div class="rounded-2xl p-6 glass-card flex-1 flex flex-col overflow-hidden min-h-[300px]">
                <h2 class="text-lg font-semibold flex items-center text-white/90 mb-4">
                    <svg class="w-5 h-5 mr-2 text-soft-amber" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Tasks
                </h2>
                <form id="quick-add-form" class="mb-4 relative">
                    <input type="text" id="quick-add-input"
                        class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 pl-12 text-sm text-white focus:outline-none focus:border-soft-amber transition-colors"
                        placeholder="Type a task and hit Enter...">
                    <span
                        class="absolute left-4 top-3.5 text-white/40 font-mono text-xs border border-white/20 rounded px-1">A</span>
                    <button type="submit" class="absolute right-3 top-2.5 p-1 text-white/40 hover:text-white/80">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                    </button>
                </form>

                <div class="flex-grow overflow-y-auto pr-2 min-h-0 space-y-4 kanban-container">
                    <div>
                        <h3 class="text-xs uppercase tracking-wider font-semibold text-white/40 mb-2 ml-1">Focus / Doing
                        </h3>
                        <div class="space-y-2 kanban-dropzone min-h-[40px] rounded-xl border border-dashed border-transparent transition-all"
                            id="list-doing" data-status="doing">
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xs uppercase tracking-wider font-semibold text-white/40 mb-2 ml-1 mt-4">Next Up
                            / Todo</h3>
                        <div class="space-y-2 kanban-dropzone min-h-[40px] rounded-xl border border-dashed border-transparent transition-all"
                            id="list-todo" data-status="todo">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trips (Bottom Half) -->
            <div class="rounded-2xl p-5 glass-card flex-1 flex flex-col overflow-hidden min-h-[300px]">
                <h2 class="text-md font-semibold flex items-center text-white/90 mb-4 shrink-0">
                    <svg class="w-5 h-5 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    Upcoming Trips
                </h2>
                <div id="trips-container" class="flex-grow overflow-y-auto pr-2 space-y-3">
                    <div class="text-sm text-white/40 italic">Syncing Calendar data...</div>
                </div>
            </div>
        </div>


        <!-- Column 3: Events -->
        <div
            class="lg:col-span-3 flex flex-col rounded-2xl p-6 glass-card h-[80vh] overflow-hidden hide-in-zen transition-all-slow">
            <div class="mb-6">
                <h2 class="text-lg font-semibold flex items-center text-white/90 mb-1">
                    <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                        </path>
                    </svg>
                    Events
                </h2>
            </div>
            <div id="calendar-container" class="flex-grow overflow-y-auto pr-2 space-y-4">
                <div class="flex flex-col items-center justify-center h-full text-white/40">
                    <svg class="w-8 h-8 mb-2 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span>Loading Events...</span>
                </div>
            </div>
        </div>


        <!-- Invisible structure to align perfectly with Schedule bottom half -->
        <div class="flex-1 min-h-[300px] pointer-events-none"></div>
    </div>
    </div>

    <!-- Zen Focus Overlay -->
    <div id="zen-layout"
        class="fixed inset-0 z-40 hidden flex-col items-center justify-center pointer-events-none opacity-0 transition-opacity duration-700">
        <div class="pointer-events-auto text-center max-w-3xl px-6 w-full">
            <h2 class="text-sm uppercase tracking-[0.3em] text-white/40 mb-8">One Thing at a Time</h2>
            <div id="zen-task-display"
                class="text-4xl md:text-5xl lg:text-6xl font-semibold text-white/90 leading-tight mb-16">
                <!-- Task inserted here -->
            </div>
            <button id="zen-complete-btn"
                class="glass px-8 py-3 rounded-full font-medium text-white/80 hover:text-white hover:bg-white/10 transition-colors border-white/10 hidden">
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Mark Complete
            </button>
        </div>
    </div>

    <!-- Hidden Authentication Modal -->
    <div id="auth-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="glass-card p-8 rounded-2xl max-w-md w-full text-center">
            <h2 class="text-xl font-bold mb-4">Google Authentication Required</h2>
            <p class="text-sm text-white/70 mb-6">Personal-OS needs permission to read your Calendar and Gmail to
                populate the dashboard.</p>
            <a id="auth-link" href="#" target="_blank"
                class="inline-block bg-white text-black font-medium px-6 py-3 rounded-full hover:bg-gray-200 transition mb-6">Authorize
                with Google</a>

            <div class="text-left mt-4 border-t border-white/10 pt-4">
                <p class="text-xs text-white/50 mb-2">After authorizing, paste the code here:</p>
                <div class="flex space-x-2">
                    <input type="text" id="auth-code-input"
                        class="flex-grow bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-soft-amber"
                        placeholder="Paste code...">
                    <button id="submit-auth-code"
                        class="bg-soft-amber/20 text-soft-amber border border-soft-amber/30 px-4 py-2 rounded-lg text-sm hover:bg-soft-amber/30 transition">Submit</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Application Logic -->
    <script>
        const API_BASE = 'http://localhost:3000/api';

        let localTasks = [];

        // --- DOM Elements ---
        const authStatusEl = document.getElementById('auth-status');
        const authModal = document.getElementById('auth-modal');
        const authLink = document.getElementById('auth-link');
        const authCodeInput = document.getElementById('auth-code-input');
        const submitAuthCodeBtn = document.getElementById('submit-auth-code');
        const zenToggle = document.getElementById('zen-toggle');

        // --- Zen Mode Handle ---
        let isZenMode = false;
        const mainLayout = document.getElementById('main-layout');
        const zenLayout = document.getElementById('zen-layout');
        const zenTaskDisplay = document.getElementById('zen-task-display');
        let currentZenTaskId = null;

        function updateZenDisplay() {
            const doingTasks = localTasks.filter(t => t.status === 'doing');
            if (doingTasks.length > 0) {
                zenTaskDisplay.textContent = doingTasks[0].title;
                currentZenTaskId = doingTasks[0].id;
                document.getElementById('zen-complete-btn').classList.remove('hidden');
            } else {
                zenTaskDisplay.textContent = "Breathe. You have no active focus.";
                currentZenTaskId = null;
                document.getElementById('zen-complete-btn').classList.add('hidden');
            }
        }

        zenToggle.addEventListener('click', () => {
            isZenMode = !isZenMode;
            if (isZenMode) {
                document.body.classList.add('zen-active');

                mainLayout.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
                mainLayout.classList.remove('opacity-100', 'scale-100');

                zenLayout.classList.remove('hidden');
                updateZenDisplay();
                // small delay for transition trigger
                setTimeout(() => zenLayout.classList.add('opacity-100'), 50);

                zenToggle.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Exit Zen</span>`;
            } else {
                document.body.classList.remove('zen-active');

                zenLayout.classList.remove('opacity-100');
                setTimeout(() => {
                    zenLayout.classList.add('hidden');
                    mainLayout.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
                    mainLayout.classList.add('opacity-100', 'scale-100');
                }, 700);

                zenToggle.innerHTML = `
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    <span>Enter Zen Mode</span>`;
            }
        });

        document.getElementById('zen-complete-btn').addEventListener('click', () => {
            if (currentZenTaskId) {
                const task = localTasks.find(t => t.id === currentZenTaskId);
                if (task) {
                    task.status = 'done';
                    saveTasks();
                    renderTasks();
                    updateZenDisplay();
                }
            }
        });

        // --- Authentication Flow ---
        async function checkAuthAndFetch(endpoint, containerId, renderFn) {
            try {
                const res = await fetch(`${API_BASE}/${endpoint}`);
                const data = await res.json();

                if (data.requiresAuth) {
                    showAuthModal();
                    return;
                }

                if (data.error) throw new Error(data.error);

                authStatusEl.textContent = '‚óè Google Connected';
                authStatusEl.className = 'text-sm font-medium px-4 py-2 rounded-full glass border-green-500/30 text-green-400 hide-in-zen';

                renderFn(data, document.getElementById(containerId));
            } catch (err) {
                console.error(`Failed fetching ${endpoint}:`, err);
                document.getElementById(containerId).innerHTML = `<div class="text-red-400 text-sm p-4 bg-red-500/10 rounded-lg border border-red-500/20">Error: ${err.message}</div>`;
            }
        }

        async function showAuthModal() {
            authModal.classList.remove('hidden');
            const res = await fetch(`${API_BASE}/auth/url`);
            const data = await res.json();
            authLink.href = data.url;
        }

        submitAuthCodeBtn.addEventListener('click', async () => {
            const code = authCodeInput.value.trim();
            if (!code) return;

            try {
                submitAuthCodeBtn.textContent = 'Verifying...';
                submitAuthCodeBtn.disabled = true;
                const res = await fetch(`${API_BASE}/auth/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();
                if (data.success) {
                    authModal.classList.add('hidden');
                    loadDashboardData(); // Reload everything
                } else {
                    throw new Error(data.error);
                }
            } catch (err) {
                alert('Authentication failed: ' + err.message);
            } finally {
                submitAuthCodeBtn.textContent = 'Submit';
                submitAuthCodeBtn.disabled = false;
            }
        });

        // --- Render Functions ---
        function renderCalendar(events, container) {
            if (!events || events.length === 0) {
                container.innerHTML = '<div class="text-sm text-white/50 p-4">No events in the upcoming 30 days.</div>';
                return;
            }

            container.innerHTML = '';
            // Group by day roughly
            events.forEach(event => {
                const date = new Date(event.start);
                const isToday = new Date().toDateString() === date.toDateString();

                const timeStr = event.start.includes('T') ?
                    date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'All Day';

                const el = document.createElement('div');
                el.className = `p-3 rounded-lg border ${isToday ? 'bg-blue-500/10 border-blue-500/30' : 'glass border-white/5'} flex justify-between items-start cursor-grab active:cursor-grabbing hover:bg-white/5 transition-colors`;
                el.draggable = true;
                el.addEventListener('dragstart', (e) => {
                    el.style.opacity = '0.5';
                    e.dataTransfer.setData('text/plain', 'NEW_TASK:' + (event.summary || 'Busy'));
                });
                el.addEventListener('dragend', () => el.style.opacity = '1');
                el.innerHTML = `
                    <div>
                        <p class="font-medium text-sm text-white/90 leading-tight mb-1">${event.summary || 'Busy'}</p>
                        <p class="text-xs ${isToday ? 'text-blue-300' : 'text-white/50'}">${timeStr} ‚Ä¢ ${date.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' })}</p>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function renderInbox(messages, container) {
            if (!messages || messages.length === 0) {
                container.innerHTML = '<div class="text-sm text-white/50 p-4">Inbox zero!</div>';
                return;
            }
            container.innerHTML = messages.map(msg => {
                const title = (msg.subject || 'Email').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <div class="p-3 bg-white/5 hover:bg-white/10 transition-colors rounded-lg border border-white/5 cursor-grab active:cursor-grabbing"
                     draggable="true" 
                     ondragstart="this.style.opacity='0.5'; event.dataTransfer.setData('text/plain', 'NEW_TASK:' + '${title}');"
                     ondragend="this.style.opacity='1';">
                    <p class="text-xs font-semibold text-white/70 truncate mb-1">${msg.from}</p>
                    <p class="text-sm font-medium text-white/90 truncate">${msg.subject}</p>
                </div>
            `}).join('');
        }

        function renderTrips(trips, container) {
            if (!trips || trips.length === 0) {
                container.innerHTML = '<div class="text-sm text-white/50 p-4">No upcoming bookings found.</div>';
                return;
            }
            container.innerHTML = trips.map(trip => {
                const isHotel = trip.tripType === 'hotel';
                const isTrain = trip.tripType === 'train';

                // Color Code: Emerald green for Flights/Trains, Teal green for Hotels
                const bgClass = isHotel ? 'bg-teal-500/10' : 'bg-emerald-500/10';
                const borderClass = isHotel ? 'border-teal-500/20' : 'border-emerald-500/20';
                const textClass = isHotel ? 'text-teal-300' : 'text-emerald-300';

                const icon = isHotel ? 'üè®' : (isTrain ? 'üöÜ' : '‚úàÔ∏è');

                return `
                <div class="p-3 ${bgClass} border ${borderClass} rounded-lg mb-2">
                    <p class="text-sm font-medium ${textClass} mb-1">${icon} ${trip.subject}</p>
                    <p class="text-xs text-white/50">${trip.dateStr !== 'Unknown Date' ? trip.dateStr : ''}</p>
                </div>
            `}).join('');
        }

        // --- Kanban Logic ---
        async function loadTasks() {
            try {
                const res = await fetch(`${API_BASE}/tasks`);
                localTasks = await res.json();
                renderTasks();
            } catch (err) {
                console.error("Failed loading tasks", err);
            }
        }

        function saveTasks() {
            fetch(`${API_BASE}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(localTasks)
            }).catch(console.error);
        }

        function renderTasks() {
            const todoList = document.getElementById('list-todo');
            const doingList = document.getElementById('list-doing');

            // Keep the "drag tasks here" placeholder if empty
            todoList.innerHTML = localTasks.filter(t => t.status === 'todo').length === 0 ? '<div class="text-sm text-white/30 italic text-center py-4">Drag tasks here</div>' : '';
            doingList.innerHTML = localTasks.filter(t => t.status === 'doing').length === 0 ? '<div class="text-sm text-white/30 italic text-center py-4">Drag tasks here</div>' : '';

            localTasks.forEach(task => {
                if (task.status === 'done') return; // Don't render done tasks in this minimal view

                const el = document.createElement('div');
                el.className = `task-item p-3 rounded-lg border border-white/10 ${task.status === 'doing' ? 'bg-soft-amber/10 border-soft-amber/30' : 'bg-white/5'}`;
                el.draggable = true;
                el.dataset.id = task.id;

                // Content
                const timeBadge = task.scheduledTime ? `<div class="mt-2 text-xs font-medium text-blue-300 bg-blue-500/10 inline-block px-2 py-0.5 rounded border border-blue-500/20">üìÖ ${new Date(task.scheduledTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} - ${task.scheduledReasoning}</div>` : '';
                const loadingBadge = task.isScheduling ? `<div class="mt-2 text-xs font-medium text-soft-amber animate-pulse">‚ú® AI is finding a time...</div>` : '';

                el.innerHTML = `
                    <div class="flex items-start">
                        <input type="checkbox" class="task-checkbox mt-1 mr-3 w-4 h-4 rounded border-gray-600 bg-gray-700 text-soft-amber focus:ring-soft-amber/50 cursor-pointer" data-id="${task.id}">
                        <div class="flex-grow">
                            <p class="text-sm text-white/90 leading-snug">${task.title}</p>
                            ${loadingBadge}
                            ${timeBadge}
                        </div>
                    </div>
                `;

                // Hover tracking for "X" auto-schedule
                el.addEventListener('mouseenter', () => hoveredTaskId = task.id);
                el.addEventListener('mouseleave', () => hoveredTaskId = null);

                // Drag Events
                el.addEventListener('dragstart', (e) => {
                    el.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', task.id);
                });
                el.addEventListener('dragend', () => el.classList.remove('dragging'));

                // Checkbox event (Mark Done)
                const cb = el.querySelector('.task-checkbox');
                cb.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        el.style.opacity = '0.5';
                        el.style.textDecoration = 'line-through';
                        setTimeout(() => {
                            const t = localTasks.find(t => t.id === task.id);
                            if (t) t.status = 'done';
                            saveTasks();
                            renderTasks();
                        }, 500);
                    }
                });

                if (task.status === 'todo') todoList.appendChild(el);
                if (task.status === 'doing') doingList.appendChild(el);
            });
        }

        // Set up Drag and Drop Zones
        document.querySelectorAll('.kanban-dropzone').forEach(zone => {
            zone.addEventListener('dragover', e => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
            zone.addEventListener('drop', e => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                const dragData = e.dataTransfer.getData('text/plain');
                const newStatus = zone.dataset.status;

                // Handle Dropped External Item (Email or Calendar Event)
                if (dragData.startsWith('NEW_TASK:')) {
                    const title = dragData.substring(9);
                    localTasks.push({ id: Date.now().toString(), title, status: newStatus });
                    saveTasks();
                    renderTasks();
                    return;
                }

                // Handle Existing Kanban Task Move
                const task = localTasks.find(t => t.id === dragData);
                if (task && task.status !== newStatus) {
                    task.status = newStatus;
                    saveTasks();
                    renderTasks();
                    if (newStatus === 'doing' && isZenMode) updateZenDisplay();
                }
            });
        });

        // Quick Add Task Form
        const quickAddForm = document.getElementById('quick-add-form');
        const quickAddInput = document.getElementById('quick-add-input');
        if (quickAddForm && quickAddInput) {
            quickAddForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const title = quickAddInput.value.trim();
                if (title) {
                    localTasks.push({ id: Date.now().toString(), title, status: 'todo' });
                    saveTasks();
                    renderTasks();
                    quickAddInput.value = '';
                }
            });
        }

        // --- Sunsama Global Hotkeys (A = Add Task, X = Auto-Schedule) ---
        let hoveredTaskId = null;
        let globalCalendarEvents = []; // Cache for AI scheduler

        document.addEventListener('keydown', async (e) => {
            // Ignore if typing in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // 'A' to Quick Add
            if (e.key.toLowerCase() === 'a') {
                e.preventDefault();
                quickAddInput.focus();
            }

            // 'X' to Auto-Schedule hovered task
            if (e.key.toLowerCase() === 'x' && hoveredTaskId) {
                e.preventDefault();
                const task = localTasks.find(t => t.id === hoveredTaskId);
                if (task && !task.isScheduling) {
                    task.isScheduling = true;
                    renderTasks(); // Show loading state

                    try {
                        const res = await fetch(`${API_BASE}/ai/schedule`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                taskTitle: task.title,
                                calendarEvents: globalCalendarEvents
                            })
                        });

                        const suggestion = await res.json();
                        if (suggestion.error) throw new Error(suggestion.error);

                        task.scheduledTime = suggestion.recommendedTime;
                        task.scheduledReasoning = suggestion.reasoning;
                    } catch (err) {
                        console.error('AI Auto-Schedule failed:', err);
                        alert('Could not auto-schedule: ' + err.message);
                    } finally {
                        task.isScheduling = false;
                        saveTasks();
                        renderTasks();
                    }
                }
            }
        });

        // --- Initialization & Background Sync ---
        function loadDashboardData() {
            loadTasks();
            fetchGoogleData();
        }

        function fetchGoogleData() {
            // Re-fetch calendar events
            checkAuthAndFetch('calendar', 'calendar-container', (data, container) => {
                globalCalendarEvents = data;
                renderCalendar(data, container);
            });

            // Re-fetch unread emails
            checkAuthAndFetch('inbox', 'inbox-container', renderInbox);

            // Re-fetch trips if necessary (optional polling)
            checkAuthAndFetch('trips', 'trips-container', renderTrips);

            // Flash the auth pill briefly to indicate a background sync occurred
            if (authStatusEl.textContent.includes('Connected')) {
                authStatusEl.classList.add('bg-green-500/20');
                setTimeout(() => authStatusEl.classList.remove('bg-green-500/20'), 1000);
            }
        }

        // --- Context HUD (Time & Weather) ---
        function updateHUDClock() {
            const now = new Date();
            const dateEl = document.getElementById('hud-date');
            const timeEl = document.getElementById('hud-time');

            // Format: "Wed 11 Mar"
            dateEl.textContent = now.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });

            // Format: "14:05" (24-hour)
            timeEl.textContent = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        }

        async function fetchHUDWeather() {
            const weatherEl = document.getElementById('hud-weather');
            try {
                // Fetch London weather
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.5085&longitude=-0.1257&current=temperature_2m,weather_code');
                const data = await response.json();

                const temp = Math.round(data.current.temperature_2m);
                const code = data.current.weather_code;

                let emoji = 'üå§Ô∏è';
                if (code === 0) emoji = '‚òÄÔ∏è';
                else if (code >= 1 && code <= 3) emoji = '‚òÅÔ∏è';
                else if (code >= 45 && code <= 48) emoji = 'üå´Ô∏è';
                else if (code >= 51 && code <= 67) emoji = 'üåßÔ∏è';
                else if (code >= 71 && code <= 77) emoji = '‚ùÑÔ∏è';
                else if (code >= 80 && code <= 82) emoji = 'üå¶Ô∏è';
                else if (code >= 95) emoji = '‚ö°';

                weatherEl.innerHTML = `${emoji} ${temp}&deg;C`;
            } catch (err) {
                console.error("Failed to fetch weather", err);
                weatherEl.textContent = '--¬∞C';
            }
        }

        // Start App on Initial Load
        loadDashboardData();
        updateHUDClock();
        fetchHUDWeather();
        setInterval(updateHUDClock, 1000); // Tick clock every second
        setInterval(fetchHUDWeather, 15 * 60 * 1000); // Fetch weather every 15 mins

        // Start Background Polling (Every 60 seconds)
        setInterval(fetchGoogleData, 60000);

    </script>
</body>

</html>